<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>
    <link rel="stylesheet" type="text/css" href="demo.css">
	<script src="../src/js/lib/avalon/avalon.js"></script>
</head>
<body ms-controller='configure'>
    <div class='west'>
        <div ms-repeat="panelData">
            <div class='panel-title' ms-click="$selPanel($index)">{{el.title}}</div>
            <div class='panel-content clearfix' ms-data-type='el.type' ms-visible='curIndex === $index'>
                <div class='fl item' ms-repeat-img="el.data" 
                    ms-mousedown="$beforeMove($event,img)"
                    data-repeat-rendered='$rendered' ms-data-img='img'>
                    <img ms-if='img.src' ms-src='../src/imglib/{{img.src}}' 
                        ms-css-width='img.width' ms-css-height='img.height' 
                        ms-data-type-val='img.typeVal'/>
                </div>
            </div>
        </div>
    </div>
    <div class='center'>
        <div id='paper'></div>
    </div>
    <div class='proxy' ms-visible='proxy.show' ms-css-left='proxy.left' 
        ms-css-top='proxy.top' ms-css-cursor="proxy.cursor">
        <img ms-if='proxy.src' ms-src='../src/imglib/{{proxy.src}}' 
            ms-css-width='proxy.width' ms-css-height='proxy.height' 
            ms-data-type-val='proxy.typeVal'/>
    </div>
    <script>
        function getItem(name){
            return {
                $name : name,
                src : null,
                width : null,
                height : null,
                typeVal : null
            };
        }
        require(["../../configure.imglib.js","../../configure.edit"],function(Imglib,Configure){
            var configure = new Configure("paper");
            var vmodel = avalon.define("configure",function(vm){
                vm.panelData = [{
                    title : "连线",
                    type : "line",
                    data : [getItem("double"),getItem("dotted"),getItem("solid")]
                },{
                    title : "连接器",
                    type : "connector",
                    data : [getItem("left-bottom"),getItem("left-right"),getItem("left-top")]
                }];
                vm.curIndex = 0;
                vm.proxy = {
                    cursor : "not-allowed",
                    show : false,
                    src : null,
                    width : null,
                    height : null,
                    left : null,
                    top : null,
                    typeVal : null
                };
                vm.$selPanel = function(i){
                    vm.curIndex = i;
                };
                vm.$rendered = function(action,i,arr){
                    if(action === 'add'){
                        avalon.each(arr,function(i,img){
                            var target = Imglib[img.$name];
                            img.src = target.src;
                            img.width = target.w;
                            img.height = target.h;
                            img.typeVal = target.typeVal;
                            img.$points = target.points;
                        });
                    }
                };
                vm.$beforeMove = function(e,img){
                    e.preventDefault();
                    var type = this.parentNode.getAttribute("data-type");
                    var offset = avalon(this).offset();
                    var sX = e.pageX;
                    var sY = e.pageY;
                    var sL = offset.left;
                    var sT = offset.top;
                    var proxy = vmodel.proxy;
                    avalon.mix(proxy,{
                        show : true,
                        left : sL,
                        top : sT,
                        src : img.src,
                        width : img.width,
                        height : img.height,
                        typeVal : img.typeVal
                    });
                    var panelW = 200;
                    var move = avalon.bind(document,"mousemove",function(moveE){
                        if(moveE.pageX > panelW){
                            proxy.cursor = "move";
                        }else{
                            proxy.cursor = "not-allowed";
                        }
                        proxy.left = sL + (moveE.pageX - sX);
                        proxy.top = sT + (moveE.pageY - sY);
                    });
                    var up = avalon.bind(document,"mouseup",function(upE){
                        if(upE.pageX > panelW){
                            if(type === "line"){
                                configure.add(type,img.typeVal,proxy.left - panelW,proxy.top);
                            }else if(type === "connector"){
                                configure.add(type,img.typeVal || "","../src/imglib/" + proxy.src,
                                    proxy.left - panelW,proxy.top,proxy.width,proxy.height,img.$points);
                            }
                        }
                        proxy.show = false;
                        avalon.unbind(document,"mouseup",up);
                        avalon.unbind(document,"mousemove",move);
                    });
                };
            });
            avalon.scan();
        });
    </script>
</body>
</html>