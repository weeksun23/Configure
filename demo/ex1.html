<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>
    <link rel="stylesheet" type="text/css" href="demo.css">
    <link rel="stylesheet" type="text/css" href="../src/lib/avalon/base.css">
    <link rel="stylesheet" type="text/css" href="../src/lib/avalon/menu/avalon.menu.css">
    <link rel="stylesheet" type="text/css" href="demo.css">
	<script src="../src/lib/avalon/avalon.js"></script>
</head>
<body ms-controller='configure'>
    <div class='west'>
        <div ms-repeat="panelData">
            <div class='panel-title' ms-click="$selPanel($index)">{{el.title}}</div>
            <div class='panel-content clearfix' ms-data-type='el.type' ms-visible='curIndex === $index'>
                <span class='item' ms-repeat-img="el.data" 
                    ms-mousedown="$beforeMove($event,img)"
                    data-repeat-rendered='$rendered' ms-data-img='img'>
                    <img ms-if='img.src' ms-src='{{path}}{{img.src}}' 
                        ms-css-width='img.width' ms-css-height='img.height' 
                        ms-data-type-val='img.typeVal'/>
                </span>
            </div>
        </div>
    </div>
    <div class='center'>
        <div id='paper'></div>
    </div>
    <div class='east'>
        <a class='forkme' href='https://github.com/weeksun23/Configure'></a>
        <div class='mgt5 tac'>
            <button ms-click="$saveData()">保存数据</button>
            <button ms-click="$loadData()">加载数据</button>
            <textarea class='data-area' ms-value='dataStr'></textarea>
        </div>
    </div>
    <div class='proxy' ms-visible='proxy.show' ms-css-left='proxy.left' 
        ms-css-top='proxy.top' ms-css-cursor="proxy.cursor">
        <img ms-if='proxy.src' ms-src='{{path}}{{proxy.src}}' 
            ms-css-width='proxy.width' ms-css-height='proxy.height' 
            ms-data-type-val='proxy.typeVal'/>
    </div>
    <div ms-widget="menu,elmenu,$elmenuOpts"></div>
    <script>
        function getItem(name){
            return {
                $name : name,
                src : null,
                width : null,
                height : null,
                typeVal : null,
                $points : null
            };
        }
        function getItemList(str){
            var arr = str.split(",");
            var result = [];
            for(var i=0,ii;ii=arr[i++];){
                result.push(getItem(ii));
            }
            return result;
        }
        require(["../../configure.edit","../../data1","menu/avalon.menu"],function(Configure,configureData){
            Configure.init("../src/imglib/");
            var imgLib = Configure.imgLib;
            var configure = new Configure("paper");
            var vmodel = avalon.define("configure",function(vm){
                vm.dataStr = '';
                vm.path = Configure.path;
                vm.panelData = [{
                    title : "连线",
                    type : "line",
                    data : getItemList("double,dotted,solid")
                },{
                    title : "连接器",
                    type : "connector",
                    data : getItemList('left-bottom,left-right,left-top,right-bottom,right-top,top-bottom,blue-bottom,blue-left,blue-right,blue-top,red-bottom,red-left,red-right,red-top,pipe-left-right-top,pipe-top-left-bottom,pipe-left-right-bottom,pipe-bottom-right-top,control-left-right,control-left-right2')
                },{
                    title : "设备",
                    type : "device",
                    data : getItemList("plc,climate,change")
                }];
                vm.curIndex = 0;
                vm.proxy = {
                    cursor : "not-allowed",
                    show : false,
                    src : null,
                    width : null,
                    height : null,
                    left : null,
                    top : null,
                    typeVal : null
                };
                vm.$selPanel = function(i){
                    vm.curIndex = i;
                };
                vm.$rendered = function(action,i,arr){
                    if(action === 'add'){
                        avalon.each(arr,function(i,img){
                            var target = imgLib[img.$name];
                            img.src = target.src;
                            img.width = target.w;
                            img.height = target.h;
                            img.typeVal = target.typeVal;
                            img.$points = target.points;
                        });
                    }
                };
                vm.$beforeMove = function(e,img){
                    e.preventDefault();
                    var type = this.parentNode.getAttribute("data-type");
                    var offset = avalon(this).offset();
                    var sX = e.pageX;
                    var sY = e.pageY;
                    var sL = offset.left;
                    var sT = offset.top;
                    var proxy = vmodel.proxy;
                    avalon.mix(proxy,{
                        show : true,
                        left : sL,
                        top : sT,
                        src : img.src,
                        width : img.width,
                        height : img.height,
                        typeVal : img.typeVal
                    });
                    var panelW = 200;
                    var move = avalon.bind(document,"mousemove",function(moveE){
                        moveE.preventDefault();
                        if(moveE.pageX > panelW){
                            proxy.cursor = "move";
                        }else{
                            proxy.cursor = "not-allowed";
                        }
                        proxy.left = sL + (moveE.pageX - sX);
                        proxy.top = sT + (moveE.pageY - sY);
                    });
                    var up = avalon.bind(document,"mouseup",function(upE){
                        if(upE.pageX > panelW){
                            if(type === "line"){
                                var el = configure.add(type,img.typeVal,[proxy.left - panelW,proxy.top]);
                            }else if(type === "connector" || type === "device"){
                                var el = configure.add(type,img.typeVal,[Configure.path + proxy.src,
                                    proxy.left - panelW,proxy.top,proxy.width,proxy.height],{
                                        points : img.$points
                                    });
                            }
                            el.rightClick(function(e){
                                avalon.vmodels.elmenu.show(e.clientX,e.clientY,this);
                            });
                        }
                        proxy.show = false;
                        avalon.unbind(document,"mouseup",up);
                        avalon.unbind(document,"mousemove",move);
                    });
                };
                vm.$saveData = function(){
                    var data = configure.saveData();
                    vm.dataStr = data;
                };
                vm.$loadData = function(){
                    configure.loadData(configureData);
                };
                vm.$elmenuOpts = {
                    isShow : false,
                    menuList : [{
                        text : "删除",
                        click : function(target){
                            configure.removeEl(target);
                        }
                    },{
                        text : "解除连接关系",
                        click : function(target){
                            configure.removeElConn(target);
                        }
                    }]
                };
            });
            avalon.scan();
        });
    </script>
</body>
</html>